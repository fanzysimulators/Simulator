<!DOCTYPE html>
<html lang="en">
<head>
<link rel="icon" type="image/png" href="../../favicon.png">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Relationships — The Challenge: Final Reckoning</title>

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="./style.css" />

<style>
  #rel-grid{
    display:grid; gap:16px;
    grid-template-columns:repeat(4,minmax(240px,1fr));
  }
  @media (max-width:1200px){#rel-grid{grid-template-columns:repeat(3,minmax(240px,1fr));}}
  @media (max-width:900px){#rel-grid{grid-template-columns:repeat(2,minmax(240px,1fr));}}
  @media (max-width:560px){#rel-grid{grid-template-columns:1fr;}}

  .rel-card.mini-card{padding:14px; gap:10px; max-width:360px; margin-inline:auto;}
  .rel-card .avatar{width:96px;height:96px;}
  .rel-card .name{font-weight:600;}

  .neo-select{
    --glow: rgba(106,169,255,.28);
    position:relative; width:100%;
    border-radius:12px; padding:1px;
    background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.08));
    box-shadow: 0 0 0 1px rgba(255,255,255,.10) inset, 0 0 18px var(--glow);
    transition: box-shadow .25s ease, transform .2s ease;
    backdrop-filter: blur(var(--panel-blur));
  }
  .neo-select:focus-within{
    box-shadow: 0 0 0 1px rgba(255,255,255,.12) inset, 0 0 26px var(--glow);
    transform: translateY(-1px);
  }
  .neo-select select{
    appearance:none; -webkit-appearance:none; width:100%;
    border:none; outline:none; border-radius:10px;
    padding:12px 44px 12px 14px;
    font-weight:600; color:var(--text);
    background: rgba(255,255,255,.06);
    transition: background-color .25s ease, color .25s ease, box-shadow .2s ease;
    box-shadow: inset 0 1px 0 rgba(255,255,255,.35), inset 0 -1px 0 rgba(0,0,0,.12);
  }
  .neo-select::after{
    content:""; position:absolute; right:12px; top:50%; width:14px; height:14px; pointer-events:none;
    transform: translateY(-50%);
    background-image: url('data:image/svg+xml;utf8,<svg width="14" height="14" viewBox="0 0 24 24" fill="%23ffffff" xmlns="http://www.w3.org/2000/svg"><path opacity="0.9" d="M7 10l5 5 5-5"/></svg>');
    filter: drop-shadow(0 1px 2px rgba(0,0,0,.35));
    opacity:.9;
  }

  .focus-avatar-wrap { display: grid; justify-items: center; gap: 8px; margin-bottom: 8px; }
  .focus-name { font-weight: 600; }

.neo-select select{
  appearance:none; -webkit-appearance:none; width:100%;
  border:none; outline:none; border-radius:10px;
  padding:12px 44px 12px 14px;
  font-weight:600;

  background-color:#0d0d0d !important;
  color:#fff !important;
  color-scheme: dark;

  box-shadow: inset 0 1px 0 rgba(255,255,255,.12), inset 0 -1px 0 rgba(0,0,0,.35);
}

.filter select {
  background: #0d0d0d;
  color: #ffffff;
}

.filter select option {
  background: #0d0d0d;
  color: #ffffff;
}
</style>
</head>
<body>
  <div class="bg fx-nebula" aria-hidden="true"></div>
  <div class="bg fx-hex" aria-hidden="true"></div>
  <div class="bg fx-circuit" aria-hidden="true"></div>
  <div class="bg fx-glow" aria-hidden="true"></div>

  <header class="site-header">
    <div class="brand">
      <span class="logo-dot" aria-hidden="true"></span>
      <h1>The Challenge — Free Agents</h1>
    </div>
    <nav class="top-nav" aria-label="Primary">
      <a class="btn nav" href="../../index.html">Home</a>
      <button class="btn" id="btn-reset-session" type="button">Reset Season</button>
    </nav>
  </header>

  <div class="page-shell antm-shell">
    <aside class="sidebar left">
      <div class="panel">
        <h3>Relationships</h3>

        <div class="focus-avatar-wrap">
          <img id="focus-avatar" class="avatar ring" src="./BlankProfile.webp" alt="">
          <div id="focus-name" class="focus-name">Contestant</div>
        </div>
        <div class="filter" style="justify-content:center; margin-bottom:10px;">
          <select id="focus" aria-label="Choose focal contestant"></select>
        </div>

        <div class="stack" style="justify-content:center; margin-bottom:10px;">
          <button class="btn" id="prev" type="button">◀ Prev</button>
          <button class="btn" id="next" type="button">Next ▶</button>
        </div>

        <div class="sep"></div>

        <div class="stack" style="justify-content:center;">
          <button class="btn" id="rand-player" type="button">Randomize Player</button>
          <button class="btn" id="rand-all" type="button">Randomize Cast</button>
          <button class="btn" id="reset-player" type="button">Reset Player</button>
          <button class="btn" id="reset-all" type="button">Reset Cast</button>
        </div>

        <div class="sep"></div>
        <div class="stack" style="justify-content:center;">
          <a class="btn" href="./index.html">Back to Simulator</a>
        </div>
      </div>
    </aside>

    <main class="content">
      <section class="block">
        <header class="block-head center">
          <h2>Set Relationships</h2>
          <p class="muted">Choose a contestant on the left, then set how they feel about each of the others. Saved for this session.</p>
        </header>

        <div id="no-cast" class="center-text" hidden>
          <p class="muted">No cast found for this session. Go back and choose your cast first.</p>
          <div class="stack" style="justify-content:center;">
            <a class="btn" href="./index.html">Back</a>
          </div>
        </div>

        <div id="rel-grid"></div>
      </section>
    </main>

    <aside class="sidebar right">
      <div class="panel">
        <h3>Scale</h3>
        <ul class="bullet-list">
          <li><strong>5</strong> — Best Friend</li>
          <li><strong>4</strong> — Bonded</li>
          <li><strong>3</strong> — Close Friends</li>
          <li><strong>2</strong> — Friends</li>
          <li><strong>1</strong> — Acquaintances (Warm)</li>
          <li><strong>0</strong> — Neutral</li>
          <li><strong>-1</strong> — Acquaintances (Cold)</li>
          <li><strong>-2</strong> — Uneasy</li>
          <li><strong>-3</strong> — Dislike</li>
          <li><strong>-4</strong> — Rival</li>
          <li><strong>-5</strong> — Nemesis</li>
        </ul>
      </div>
    </aside>
  </div>

  <script src="../../player_data.js"></script>
  <script>
  (function(){
    "use strict";

    const KEY="challenge-fr-season";
    const State={load(){try{return JSON.parse(sessionStorage.getItem(KEY))||null}catch{return null}},
                 save(s){sessionStorage.setItem(KEY,JSON.stringify(s))},
                 clear(){sessionStorage.removeItem(KEY)}};
    const $=s=>document.querySelector(s);
    $("#btn-reset-session").onclick=()=>{State.clear();location.href="./index.html";};

    let state=State.load();
    if(!state || !Array.isArray(state.teams)){
      document.getElementById("no-cast").hidden=false;
      state = state || {};
    }
    state.relationships = state.relationships || {};

    function merge(dst,src){ if(!src) return; for(const k in src){ if(src[k] && !dst[k]) dst[k]=src[k]; } }
    function mapFromPlayerData(){
      const pd = window.playerData || {}; const m={};
      ["males","females","others"].forEach(b=>{
        (pd[b]||[]).forEach(p=>{ if(p&&p.id&&!m[p.id]) m[p.id]=Object.assign({},p); });
      });
      return m;
    }
    function mapFromState(st){
      const m={};
      if(Array.isArray(st.cast)){ st.cast.forEach(p=>{ if(p&&p.id&&!m[p.id]) m[p.id]=Object.assign({},p); }); }
      if(st.PLAYERS_BY_ID) merge(m, st.PLAYERS_BY_ID);
      if(Array.isArray(st.players)){ st.players.forEach(p=>{ if(p&&p.id&&!m[p.id]) m[p.id]=Object.assign({},p); }); }
      return m;
    }
    function mapFromOpener(){
      try{ if(window.opener && window.opener.PLAYERS_BY_ID) return window.opener.PLAYERS_BY_ID; }catch(_){}
      try{ if(window.parent && window.parent!==window && window.parent.PLAYERS_BY_ID) return window.parent.PLAYERS_BY_ID; }catch(_){}
      return null;
    }
    const BYID=(function(){
      const a = mapFromPlayerData();
      const b = mapFromState(state);
      const c = (typeof window.PLAYERS_BY_ID==="object") ? window.PLAYERS_BY_ID : null;
      const d = mapFromOpener();
      const out={}; merge(out,a); merge(out,b); merge(out,c); merge(out,d);
      for(const id in out){
        const p=out[id];
        p.nickname = p.nickname || p.name || id;
        p.image = p.image || ("./contestant_pictures/"+id+".webp");
      }
      return out;
    })();

    function nameOf(id){ const p=BYID[id]; return p ? (p.nickname||p.name||id) : id; }
    function imgOf(id){ const p=BYID[id]; return (p && p.image) ? p.image : "./BlankProfile.webp"; }

    function aliveCastIds(){
      const ids=[];
      (state.teams||[]).forEach(t=>{
        if(!t) return;
        if(t.aId) ids.push(t.aId);
        if(t.bId) ids.push(t.bId);
      });
      return Array.from(new Set(ids));
    }

    function getRel(a,b){
      if(a===b) return 0;
      const ra = state.relationships[a];
      if(ra && typeof ra[b]==="number") return ra[b];
      const rb = state.relationships[b];
      if(rb && typeof rb[a]==="number") return rb[a];
      return 0;
    }
    function setRel(a,b,val){
      if(a===b) return;
      if(!state.relationships[a]) state.relationships[a]={};
      state.relationships[a][b] = Number(val);
      if(!state.relationships[b]) state.relationships[b]={};
      if(typeof state.relationships[b][a] !== "number") state.relationships[b][a] = Number(val);
    }

    const REL_LABELS={5:"Best Friend",4:"Bonded",3:"Close Friends",2:"Friends",1:"Acquaintances (Warm)",0:"Neutral","-1":"Acquaintances (Cold)","-2":"Uneasy","-3":"Dislike","-4":"Rival","-5":"Nemesis"};
    const REL_VALUES=[5,4,3,2,1,0,-1,-2,-3,-4,-5];

    function updateFocusAvatar(){
      const id=$("#focus").value;
      $("#focus-avatar").src = imgOf(id);
      $("#focus-name").textContent = nameOf(id);
    }

    function renderGrid(){
      const grid=$("#rel-grid"); grid.innerHTML="";
      const focusId=$("#focus").value; if(!focusId) return;
      const others=aliveCastIds().filter(id=>id!==focusId).sort((a,b)=>nameOf(a).localeCompare(nameOf(b)));

      for(const oid of others){
        const card=document.createElement("div");
        card.className="mini-card rel-card";
        card.innerHTML=`
          <img class="avatar ring" src="${imgOf(oid)}" alt="">
          <div class="name"><strong>${nameOf(oid)}</strong></div>
          <div class="neo-select">
            <select class="rel-select" aria-label="Relationship with ${nameOf(oid)}">
              ${REL_VALUES.map(v=>`<option value="${v}">${v}: ${REL_LABELS[v]}</option>`).join("")}
            </select>
          </div>`;
        const sel=card.querySelector("select");
        sel.value=String(getRel(focusId,oid));
        sel.addEventListener("change",()=>{
          setRel(focusId,oid,Number(sel.value));
          State.save(state);
        });
        grid.appendChild(card);
      }
    }

    function randomRel(){return REL_VALUES[Math.floor(Math.random()*REL_VALUES.length)];}
    function randomizePlayer(){
      const focusId=$("#focus").value;
      aliveCastIds().forEach(oid=>{ if(oid===focusId) return; setRel(focusId,oid,randomRel()); });
      State.save(state); renderGrid();
    }
    function randomizeAll(){
      const ids=aliveCastIds();
      for(let i=0;i<ids.length;i++){
        for(let j=i+1;j<ids.length;j++){
          const v=randomRel();
          setRel(ids[i],ids[j],v);
          setRel(ids[j],ids[i],v);
        }
      }
      State.save(state); renderGrid();
    }
    function resetPlayer(){
      const focusId=$("#focus").value;
      aliveCastIds().forEach(oid=>{ if(oid===focusId) return; setRel(focusId,oid,0); setRel(oid,focusId,0); });
      State.save(state); renderGrid();
    }
    function resetAll(){
      state.relationships={}; State.save(state); renderGrid();
    }

    function buildFocus(ids){
      const sel=$("#focus");
      sel.innerHTML=ids.map(id=>`<option value="${id}">${nameOf(id)}</option>`).join("");
      sel.onchange=()=>{ updateFocusAvatar(); renderGrid(); };
    }

    function wireLeftBar(ids){
      $("#prev").onclick=()=>{
        const cur=$("#focus").value; const i=ids.indexOf(cur);
        $("#focus").value = ids[(i<=0?ids.length-1:i-1)];
        updateFocusAvatar(); renderGrid();
      };
      $("#next").onclick=()=>{
        const cur=$("#focus").value; const i=ids.indexOf(cur);
        $("#focus").value = ids[(i>=ids.length-1?0:i+1)];
        updateFocusAvatar(); renderGrid();
      };
      $("#rand-player").onclick=()=>randomizePlayer();
      $("#rand-all").onclick=()=>randomizeAll();
      $("#reset-player").onclick=()=>resetPlayer();
      $("#reset-all").onclick=()=>resetAll();
    }

    const ids = aliveCastIds().sort((a,b)=>nameOf(a).localeCompare(nameOf(b)));
    if(!ids.length){ document.getElementById("no-cast").hidden=false; }
    buildFocus(ids);
    if(ids.length){ $("#focus").value=ids[0]; updateFocusAvatar(); renderGrid(); }
    wireLeftBar(ids);

  })();
  </script>
</body>
</html>
